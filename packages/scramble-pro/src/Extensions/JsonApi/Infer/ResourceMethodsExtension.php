<?php

namespace Dedoc\ScramblePro\Extensions\JsonApi\Infer;

use Dedoc\Scramble\Infer\Extensions\Event\MethodCallEvent;
use Dedoc\Scramble\Infer\Extensions\MethodReturnTypeExtension;
use Dedoc\Scramble\Support\Type\ArrayItemType_;
use Dedoc\Scramble\Support\Type\Generic;
use Dedoc\Scramble\Support\Type\KeyedArrayType;
use Dedoc\Scramble\Support\Type\Literal\LiteralStringType;
use Dedoc\Scramble\Support\Type\ObjectType;
use Dedoc\Scramble\Support\Type\Type;
use Dedoc\Scramble\Support\Type\UnknownType;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Resources\Json\ResourceResponse;
use TiMacDonald\JsonApi\JsonApiResource;

class ResourceMethodsExtension implements MethodReturnTypeExtension
{
    public function shouldHandle(ObjectType $type): bool
    {
        return $type->isInstanceOf(JsonApiResource::class);
    }

    public function getMethodReturnType(MethodCallEvent $event): ?Type
    {
        return match ($event->getName()) {
            'response', 'toResponse' => new Generic(JsonResponse::class, [
                new Generic(ResourceResponse::class, [$event->getInstance()]),
                new UnknownType,
                new KeyedArrayType([
                    new ArrayItemType_('Content-type', new LiteralStringType('application/vnd.api+json')),
                ]),
            ]),
            default => null,
        };
    }
}
